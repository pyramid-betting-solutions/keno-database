name: ğŸ³ Build & Push PostgreSQL Image

on:
  push:
    branches: [ master, develop ]
#    paths:
#      - 'docker/postgres/**'
#      - 'Dockerfile.postgres'
  pull_request:
    branches: [ master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/postgres-keno

jobs:
  test-postgres:
    name: ğŸ§ª Test PostgreSQL Config
    runs-on: ubuntu-latest
   
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Validate PostgreSQL configuration
      run: |
        if [ -f "docker/postgres/init.sql" ]; then
          echo "âœ… PostgreSQL init script found"
          # Validate SQL syntax (basic check)
          if command -v pg_format &> /dev/null; then
            pg_format --check docker/postgres/init.sql || echo "âš ï¸ SQL formatting issues found"
          fi
        else
          echo "â„¹ï¸ No custom PostgreSQL init script found"
        fi

  build-and-push-postgres:
    name: ğŸ³ Build & Push PostgreSQL Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
   
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

# - name: ğŸ³ Build and push custom PostgreSQL image
#   uses: docker/build-push-action@v5
#   with:
#     context: .
#     file: ./Dockerfile.postgres
#     platforms: linux/amd64
#     push: true
#     tags: |
#       ${{ env.IMAGE_NAME }}:${{ github.sha }}
#       ${{ env.IMAGE_NAME }}:latest
#     cache-from: type=gha
#     cache-to: type=gha,mode=max
    - name: ğŸ³ Pull official PostgreSQL image
      run: |
        docker pull postgres:16.3

    - name: ğŸ³ Tag and push personal DockerHub
      run: |
        docker tag postgres:16.3 ${{ env.IMAGE_NAME }}:16.3
        docker tag postgres:16.3 ${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.IMAGE_NAME }}:16.3
        docker push ${{ env.IMAGE_NAME }}:latest

    - name: ğŸ“¢ Notify success
      run: |
        echo "âœ… PostgreSQL image built and pushed to personal Hub successfully!"
        echo "ğŸ“¦ Image: ${{ env.IMAGE_NAME }}:16.3"
        echo "ğŸ”— Latest: ${{ env.IMAGE_NAME }}:latest"